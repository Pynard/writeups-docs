"use strict";(self.webpackChunkwriteups_docs=self.webpackChunkwriteups_docs||[]).push([[4938],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>f});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(n),m=a,f=d["".concat(s,".").concat(m)]||d[m]||u[m]||o;return n?r.createElement(f,l(l({ref:t},c),{},{components:n})):r.createElement(f,l({ref:t},c))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[d]="string"==typeof e?e:a,l[1]=i;for(var p=2;p<o;p++)l[p]=n[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4451:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const o={},l="RARPG",i={unversionedId:"2021/RARCTF/challenges/rarpg",id:"2021/RARCTF/challenges/rarpg",title:"RARPG",description:"- File : client",source:"@site/docs/2021/RARCTF/challenges/rarpg.md",sourceDirName:"2021/RARCTF/challenges",slug:"/2021/RARCTF/challenges/rarpg",permalink:"/docs/2021/RARCTF/challenges/rarpg",draft:!1,editUrl:"https://github.com/Pynard/writeups-docs/tree/main/packages/create-docusaurus/templates/shared/docs/2021/RARCTF/challenges/rarpg.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"INFINITE_FREE_TRIAL",permalink:"/docs/2021/RARCTF/challenges/infinite_free_trial"},next:{title:"SRSA",permalink:"/docs/2021/RARCTF/challenges/srsa"}},s={},p=[{value:"Client Analysis",id:"client-analysis",level:2},{value:"Communication analysis",id:"communication-analysis",level:2}],c={toc:p};function d(e){let{components:t,...o}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"rarpg"},"RARPG"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"I've been building a brand new Massively(?) Multiplayer(?) Online Role-Playing(?) Game(?) - try it out! Just don't try and visit the secret dev room...\n\nIf you do not have the linked libraries, download rarpg-libs.zip and extract the libraries into your working directory. Then use\nLD_LIBRARY_PATH=$(pwd) ./client <ip> <port>\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"File : ",(0,a.kt)("a",{parentName:"li",href:"../attachements/rarpg/client"},"client"))),(0,a.kt)("h2",{id:"client-analysis"},"Client Analysis"),(0,a.kt)("p",null,'Here we have a client for an ascii game\\\nThe goal is to get to the "dev zone"'),(0,a.kt)("p",null,"Looking at the game we have 3 types of tile :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"walkable"),(0,a.kt)("li",{parentName:"ul"},"teleporter (X)"),(0,a.kt)("li",{parentName:"ul"},"wall (~ or W)")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                X                                                                                           \u2502\n\u2502                                                                                                            \u2502\n\u2502         ~~~~~~~~~~~~~~~      WWWWWW                                                                        \u2502\n\u2502X        ~~~~~~~~~~~~~~~      W   XW                                                                        \u2502\n\u2502         ~~~~~~~~~~~~~~~      WWWWWW                                                                        \u2502\n\u2502     *                                                                                                      \u2502\n\u2502                X                                                                                           \u2502\n\u2502                                                                                                            \u2502\n")),(0,a.kt)("p",null,"You are the ",(0,a.kt)("strong",{parentName:"p"},"*")),(0,a.kt)("p",null,"Being through all teleporters it seems that we are interested by the one enclosed by ",(0,a.kt)("strong",{parentName:"p"},"W")),(0,a.kt)("p",null,"Looking at the client, there is an interesting function ",(0,a.kt)("strong",{parentName:"p"},"sym.move_okay_int","_","_","int","_")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u250c 116: sym.move_okay_int__int_ (int64_t arg1, int64_t arg2);\n\u2502           ; var int64_t var_11h @ rbp-0x11\n\u2502           ; var int64_t var_10h @ rbp-0x10\n\u2502           ; var uint32_t var_ch @ rbp-0xc\n\u2502           ; var int64_t var_8h @ rbp-0x8\n\u2502           ; var int64_t var_4h @ rbp-0x4\n\u2502           ; arg int64_t arg1 @ rdi\n\u2502           ; arg int64_t arg2 @ rsi\n\u2502           0x00404970      55             push rbp                    ; move_okay(int, int)\n\u2502           0x00404971      4889e5         mov rbp, rsp\n[...]\n\u2502           0x004049ba      8945f4         mov dword [var_ch], eax\n\u2502           0x004049bd      837df420       cmp dword [var_ch], 0x20\n\u2502           0x004049c1      b101           mov cl, 1\n\u2502           0x004049c3      884def         mov byte [var_11h], cl\n\u2502       \u250c\u2500< 0x004049c6      0f840a000000   je 0x4049d6\n\u2502       \u2502   0x004049cc      837df458       cmp dword [var_ch], 0x58\n\u2502       \u2502   0x004049d0      0f94c0         sete al\n\u2502       \u2502   0x004049d3      8845ef         mov byte [var_11h], al\n\u2502       \u2502   ; CODE XREF from move_okay(int, int) @ 0x4049c6\n\u2502       \u2514\u2500> 0x004049d6      8a45ef         mov al, byte [var_11h]\n\u2502           0x004049d9      2401           and al, 1\n\u2502           0x004049db      0fb6c0         movzx eax, al\n\u2502           0x004049de      4883c420       add rsp, 0x20\n\u2502           0x004049e2      5d             pop rbp\n\u2514           0x004049e3      c3             ret\n")),(0,a.kt)("p",null,"Here two ",(0,a.kt)("strong",{parentName:"p"},"cmp")," are important @ 0x004049bd and 0x004049cc\nThe first check if we want to move the player to an empty tile : ",(0,a.kt)("strong",{parentName:"p"},"0x20 = ' '")," \\\nThe second one check if we are going to a teleporter : ",(0,a.kt)("strong",{parentName:"p"},"0x58 = 'X' ")),(0,a.kt)("h2",{id:"communication-analysis"},"Communication analysis"),(0,a.kt)("p",null,"To analyse communication between client and server, I have slightly modified a simple udp replay python script from ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/EtiennePerot/misc-scripts/blob/master/udp-relay.py"},"here")," (Thx to EtiennePerot) :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"File : ",(0,a.kt)("a",{target:"_blank",href:n(6479).Z},"udp-relay.py"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"#!/usr/bin/env python\n# Super simple script that listens to a local UDP port and relays all packets to an arbitrary remote host.\n# Packets that the host sends back will also be relayed to the local UDP client.\n# Works with Python 2 and 3\n\nimport sys, socket\nimport parser\nimport importlib\n\n# Whether or not to print the IP address and port of each packet received\ndebug=False\n\ndef fail(reason):\n    sys.stderr.write(reason + '\\n')\n    sys.exit(1)\n\nif len(sys.argv) != 2 or len(sys.argv[1].split(':')) != 3:\n    fail('Usage: udp-relay.py localPort:remoteHost:remotePort')\n\nlocalPort, remoteHost, remotePort = sys.argv[1].split(':')\n\ntry:\n    localPort = int(localPort)\nexcept:\n    fail('Invalid port number: ' + str(localPort))\ntry:\n    remotePort = int(remotePort)\nexcept:\n    fail('Invalid port number: ' + str(remotePort))\n\ntry:\n    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n    s.bind(('', localPort))\nexcept:\n    fail('Failed to bind on port ' + str(localPort))\n\nknownClient = None\nknownServer = (remoteHost, remotePort)\nsys.stdout.write('All set, listening on '+str(localPort)+'.\\n')\nwhile True:\n    importlib.reload(parser)\n    data, addr = s.recvfrom(32768)\n    if knownClient is None or addr != knownServer:\n        if debug:\n            print(\"\")\n        knownClient = addr\n\n    if debug:\n        print(\"Packet received from \"+str(addr))\n\n    if addr == knownClient:\n        if debug:\n            print(\"\\tforwording tO \"+str(knownServer)) \n\n        s.sendto(parser.parse(data,True), knownServer)\n    else:\n        if debug:\n            print(\"\\tforwarding to \"+str(knownClient))\n        s.sendto(parser.parse(data,False), knownClient)\n")),(0,a.kt)("p",null,"And a parser dynamically imported to manipulate packets.\\\nThanks to this we can see that packets with the map are sent from the server to the client."),(0,a.kt)("p",null,'So one way to solve this challenge is to manipulate the map for the player to be able to walk to the "dev teleporter"\nThe parser is very simple :'),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"File : ",(0,a.kt)("a",{target:"_blank",href:n(5405).Z},"parser.py"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"import binascii\n\ndef parse(data,out):\n    if len(data) != 198:\n        return data\n\n    if out:\n        print('--\x3e ',end='')\n    else:\n        print('<-- ',end='')\n\n    data = data.replace(b'W',b' ')\n    print(data)\n\n    return data\n")),(0,a.kt)("p",null,"Now the teleporter is free to walk on :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                X                                                                                           \u2502\n\u2502                                                                                                            \u2502\n\u2502         ~~~~~~~~~~~~~~~                                                                                    \u2502\n\u2502X        ~~~~~~~~~~~~~~~          X                                                                         \u2502\n\u2502         ~~~~~~~~~~~~~~~                                                                                    \u2502\n\u2502           *                                                                                                \u2502\n\u2502                X                                                                                           \u2502\n\u2502                                                                                                            \u2502\n")),(0,a.kt)("p",null,"and we get the flag :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502*                                                                                                           \u2502\n\u2502    rarctf{g4m3_h4ck1ng_f0r_n00b5!-75f8b0}                                                                  \u2502\n\u2502                                                                                                            \u2502\n\u2502                                                                                                            \u2502\n")),(0,a.kt)("p",null,"flag : ",(0,a.kt)("inlineCode",{parentName:"p"},"rarctf{g4m3_h4ck1ng_f0r_n00b5!-75f8b0}")))}d.isMDXComponent=!0},5405:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/files/parser-043a7fb2dce2e27fbceec7274a918a02.py"},6479:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/files/udp-relay-2cce79389b06e555c0dbe5b8507ce900.py"}}]);